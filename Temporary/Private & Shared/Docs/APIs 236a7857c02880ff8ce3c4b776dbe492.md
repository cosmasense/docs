# APIs

Cosma Backend API Reference

**Base URL:** `http://localhost:60534/api`

---

## Table of Contents

1. [Status](#status)
2. [Search](#search)
3. [Files](#files)
4. [Watch](#watch)
5. [Index](#index)
6. [Filters](#filters)
7. [Queue](#queue)
8. [Settings](#settings)
9. [Updates (SSE)](#updates-sse)

---

## Status

### GET /api/status/

Get current application status.

**Response:**
```json
{
  "jobs": 2
}
```

| Field | Type | Description |
|-------|------|-------------|
| `jobs` | int | Number of active background jobs |

---

## Search

### POST /api/search/

Search for files using hybrid search (semantic + full-text).

**Request:**
```json
{
  "query": "machine learning paper",
  "filters": {"extension": "pdf"},
  "limit": 50,
  "directory": "/Users/john/Documents",
  "offset": 0
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `query` | string | Yes | Search query text |
| `filters` | object | No | Filter by metadata |
| `limit` | int | No | Max results (default: 50) |
| `directory` | string | No | Scope to directory |
| `offset` | int | No | Pagination offset (default: 0) |

**Response:**
```json
{
  "results": [
    {
      "file": {
        "id": 123,
        "filename": "paper.pdf",
        "extension": "pdf",
        "file_path": "/Users/john/Documents/paper.pdf",
        "title": "Machine Learning Fundamentals",
        "summary": "An introduction to ML concepts...",
        "created": 1706745600,
        "modified": 1706745600
      },
      "relevance_score": 0.85
    }
  ],
  "total_count": 42
}
```

---

## Files

### GET /api/files/{file_id}

Get details of a specific file by ID.

**Response:**
```json
{
  "id": 123,
  "filename": "report.pdf",
  "extension": "pdf",
  "created": "1706745600",
  "modified": "1706745600",
  "summary": "Quarterly financial report...",
  "keywords": ["finance", "q4", "revenue"]
}
```

### GET /api/files/stats

Get statistics about indexed files.

**Response:**
```json
{
  "total_files": 1542,
  "total_size": 0,
  "file_types": {},
  "last_indexed": null
}
```

---

## Watch

### POST /api/watch/

Start watching a directory for file changes.

**Request:**
```json
{
  "directory_path": "/Users/john/Documents"
}
```

**Response (201):**
```json
{
  "success": true,
  "message": "Started watching directory: /Users/john/Documents",
  "files_indexed": 0
}
```

**Response (400) - Already watching:**
```json
{
  "success": false,
  "message": "Directory is already being watched",
  "files_indexed": 0
}
```

### GET /api/watch/jobs

Get all watched directory jobs.

**Response:**
```json
{
  "jobs": [
    {
      "id": 8,
      "path": "/Users/john/Downloads",
      "is_active": true,
      "recursive": true,
      "file_pattern": null,
      "last_scan": "2026-01-31T10:43:26",
      "created_at": "2026-01-31T10:43:26"
    }
  ]
}
```

### DELETE /api/watch/jobs/{job_id}

Delete a watched directory job.

**Response (200):**
```json
{
  "success": true,
  "message": "Successfully deleted watched directory: /Users/john/Downloads",
  "job_id": 8
}
```

**Response (404):**
```json
{
  "success": false,
  "message": "Watched directory with ID 8 not found",
  "job_id": 8
}
```

---

## Index

### POST /api/index/directory

Index all files in a directory via the queue.

**Request:**
```json
{
  "directory_path": "/Users/john/Documents"
}
```

**Response (201):**
```json
{
  "success": true,
  "message": "Started indexing directory: /Users/john/Documents",
  "files_indexed": 0
}
```

### POST /api/index/file

Index a single file.

**Request:**
```json
{
  "file_path": "/Users/john/Documents/report.pdf"
}
```

**Response (201):**
```json
{
  "success": true,
  "message": "Successfully indexed file: /Users/john/Documents/report.pdf",
  "file_id": null
}
```

---

## Filters

### GET /api/filters/config

Get the current filter configuration.

**Response:**
```json
{
  "version": 2,
  "mode": "whitelist",
  "exclude": [],
  "include": ["*.pdf", "*.docx"],
  "blacklist_exclude": [],
  "blacklist_include": [],
  "whitelist_include": ["*.pdf", "*.docx", "*.png"],
  "whitelist_exclude": [],
  "config_path": "/Users/john/Library/Application Support/cosma/filter.json"
}
```

| Field | Type | Description |
|-------|------|-------------|
| `version` | int | Config schema version |
| `mode` | string | `"blacklist"` or `"whitelist"` |
| `exclude` | array | Legacy exclude patterns |
| `include` | array | Legacy include patterns |
| `blacklist_exclude` | array | Patterns to exclude in blacklist mode |
| `blacklist_include` | array | Patterns to force-include in blacklist mode |
| `whitelist_include` | array | Patterns to include in whitelist mode |
| `whitelist_exclude` | array | Patterns to exclude in whitelist mode |

### PUT /api/filters/config

Update the filter configuration.

**Request:**
```json
{
  "mode": "whitelist",
  "whitelist_include": ["*.pdf", "*.docx", "*.png"],
  "whitelist_exclude": ["**/temp/*"],
  "apply_immediately": true
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `mode` | string | No | `"blacklist"` or `"whitelist"` |
| `apply_immediately` | bool | No | If true, removes excluded files from DB (default: true) |

**Response:**
```json
{
  "success": true,
  "message": "Filter configuration updated successfully",
  "config": { ... },
  "removed_count": 15
}
```

### POST /api/filters/pattern

Add a single pattern.

**Request:**
```json
{
  "pattern": "*.tmp",
  "pattern_type": "exclude"
}
```

### DELETE /api/filters/pattern

Remove a pattern.

**Request:**
```json
{
  "pattern": "*.tmp",
  "pattern_type": "exclude"
}
```

### POST /api/filters/test

Test pattern matching against file paths.

**Request:**
```json
{
  "patterns": ["*.pdf", "!**/drafts/*"],
  "file_paths": ["/docs/report.pdf", "/docs/drafts/test.pdf"],
  "mode": "whitelist"
}
```

**Response:**
```json
{
  "results": [
    {"file_path": "/docs/report.pdf", "included": true, "matched_pattern": "*.pdf"},
    {"file_path": "/docs/drafts/test.pdf", "included": false, "matched_pattern": null}
  ]
}
```

### GET /api/filters/defaults

Get default filter configuration.

### POST /api/filters/apply

Apply current filter config to database (cleanup excluded files).

### POST /api/filters/reset

Reset filter configuration to defaults.

---

## Queue

### GET /api/queue/status

Get queue status.

**Response:**
```json
{
  "paused": false,
  "manually_paused": false,
  "scheduler_paused": false,
  "total_items": 25,
  "cooling_down": 10,
  "waiting": 12,
  "processing": 3
}
```

| Field | Type | Description |
|-------|------|-------------|
| `paused` | bool | Overall paused state (manual OR scheduler) |
| `manually_paused` | bool | User-initiated pause |
| `scheduler_paused` | bool | Paused by scheduler rules |
| `cooling_down` | int | Items in debounce period |
| `waiting` | int | Items ready to process |
| `processing` | int | Items currently being processed |

### POST /api/queue/pause

Manually pause the queue.

### POST /api/queue/resume

Resume the queue.

### GET /api/queue/items

Get queue items with pagination.

**Query Parameters:**
- `offset` (int, default: 0)
- `limit` (int, default: 50)

**Response:**
```json
{
  "items": [
    {
      "id": "abc123",
      "file_path": "/docs/file.pdf",
      "action": "index",
      "status": "waiting",
      "enqueued_at": 1706745600.0,
      "cooldown_expires_at": 1706745660.0,
      "dest_path": null,
      "retry_count": 0
    }
  ],
  "total_count": 25,
  "offset": 0,
  "limit": 50
}
```

| Status | Description |
|--------|-------------|
| `cooling_down` | Debounce period, waiting for file to stabilize |
| `waiting` | Ready for processing |
| `processing` | Currently being processed |

| Action | Description |
|--------|-------------|
| `index` | Index the file |
| `delete` | Delete from index |
| `move` | Update path after file move |
| `embed_fallback` | Generate embedding for failed file |

### DELETE /api/queue/items/{item_id}

Remove an item from the queue.

### GET /api/queue/scheduler

Get scheduler configuration and status.

**Response:**
```json
{
  "enabled": true,
  "combine_mode": "ALL",
  "check_interval_seconds": 30,
  "rules": [
    {"rule": "power_source", "operator": "eq", "value": true, "enabled": true},
    {"rule": "battery_level", "operator": "gte", "value": 50, "enabled": true}
  ],
  "conditions_met": true
}
```

| Combine Mode | Description |
|--------------|-------------|
| `ALL` | All enabled rules must pass |
| `ANY` | At least one rule must pass |

### PUT /api/queue/scheduler

Update scheduler configuration.

**Request:**
```json
{
  "enabled": true,
  "combine_mode": "ALL",
  "rules": [
    {"rule": "power_source", "operator": "eq", "value": true, "enabled": true}
  ]
}
```

### GET /api/queue/scheduler/rule-types

Get metadata for scheduler rule types (for building UIs).

**Response:**
```json
{
  "rule_types": {
    "power_source": {
      "label": "Power Source",
      "description": "Require AC power (plugged in)",
      "value_type": "boolean",
      "default_operator": "eq"
    },
    "battery_level": {
      "label": "Battery Level",
      "description": "Minimum battery percentage required",
      "value_type": "percentage",
      "unit": "%",
      "default_operator": "gte",
      "min": 0,
      "max": 100
    }
  }
}
```

**Available Rule Types:**
| Rule | Value Type | Description |
|------|------------|-------------|
| `power_source` | boolean | Require AC power |
| `battery_level` | percentage | Minimum battery % |
| `gpu_usage` | percentage | Maximum GPU utilization |
| `memory_usage` | percentage | Maximum memory utilization |
| `cpu_temperature` | number | Maximum CPU temp (C) |
| `fan_speed` | number | Maximum fan speed (RPM) |
| `cpu_idle` | boolean | Require CPU to be idle |
| `time_window` | time_range | Only process during time range |
| `queue_size` | number | Minimum queue items |

### GET /api/queue/metrics

Get current system metrics.

**Response:**
```json
{
  "metrics": {
    "cpu_percent": 25.5,
    "memory_percent": 60.2,
    "battery_percent": 85,
    "power_plugged": true,
    "cpu_temp": null,
    "gpu_percent": null,
    "fan_speed": null
  }
}
```

### GET /api/queue/failed

Get failed files with pagination.

**Query Parameters:**
- `offset` (int, default: 0)
- `limit` (int, default: 50)

**Response:**
```json
{
  "files": [
    {
      "file_path": "/docs/corrupt.pdf",
      "filename": "corrupt.pdf",
      "extension": "pdf",
      "processing_error": "Failed to parse PDF: invalid format",
      "status": "FAILED",
      "updated_at": 1706745600
    }
  ],
  "total_count": 3,
  "offset": 0,
  "limit": 50
}
```

### GET /api/queue/recent

Get recently completed files with pagination.

### POST /api/queue/reindex

Reindex a specific file.

**Request:**
```json
{
  "file_path": "/docs/file.pdf"
}
```

---

## Settings

### GET /api/settings/

Get all settings.

**Response:**
```json
{
  "embedder": {
    "provider": "local",
    "model": "text-embedding-3-small",
    "dimensions": 512,
    "local_model": "intfloat/e5-base-v2",
    "local_dimensions": 768
  },
  "summarizer": {
    "provider": "auto",
    "max_tokens_per_request": 100000,
    "chunk_overlap_tokens": 1000,
    "max_chunks": 10,
    "idle_unload_seconds": 60,
    "ollama": {
      "model": "qwen3-vl:2b-instruct",
      "host": "http://localhost:11434",
      "context_length": 10000
    },
    "online": {
      "model": "openai/gpt-4.1-nano-2025-04-14",
      "context_length": 128000
    },
    "llamacpp": { ... }
  },
  "parser": {
    "extraction_strategy": "spotlight_first",
    "spotlight_enabled": true,
    "spotlight_timeout_seconds": 5,
    "max_file_size_mb": 200,
    "whisper": {
      "provider": "online",
      "online_model": "whisper-1",
      "local_model": "turbo"
    }
  },
  "queue": {
    "cooldown_seconds": 60,
    "max_concurrency": 2,
    "max_retries": 3
  },
  "scheduler": {
    "enabled": false,
    "combine_mode": "ALL",
    "check_interval_seconds": 30,
    "rules": []
  }
}
```

### PUT /api/settings/

Update settings using dotted paths.

**Request:**
```json
{
  "summarizer.provider": "ollama",
  "queue.cooldown_seconds": 30
}
```

**Response:** Updated settings object.

### GET /api/settings/defaults

Get default settings values.

---

## Updates (SSE)

### GET /api/updates/

Stream real-time updates via Server-Sent Events.

**Headers Required:**
```
Accept: text/event-stream
```

**Response:** SSE stream with `event: update` messages.

**Event Format:**
```
event: update
data: {"opcode": "file_parsing", "data": {"path": "/docs/file.pdf", "filename": "file.pdf"}}

: keepalive
```

### Update Opcodes

| Category | Opcode | Data Fields | Description |
|----------|--------|-------------|-------------|
| **File Processing** | | | |
| | `file_parsing` | path, filename | File parsing started |
| | `file_parsed` | path, filename | File parsing complete |
| | `file_summarizing` | path, filename | Summarization started |
| | `file_summarized` | path, filename | Summarization complete |
| | `file_embedding` | path, filename | Embedding started |
| | `file_embedded` | path, filename | Embedding complete |
| | `file_complete` | path, filename | Full pipeline complete |
| | `file_failed` | path, filename, error | Processing failed |
| | `file_skipped` | path, filename, reason | File skipped |
| **File System** | | | |
| | `file_created` | path | New file detected |
| | `file_modified` | path | File changed |
| | `file_deleted` | path | File removed |
| | `file_moved` | src_path, dest_path | File relocated |
| | `directory_deleted` | path | Directory removed |
| | `directory_moved` | src_path, dest_path | Directory relocated |
| **Watch** | | | |
| | `watch_added` | | New watch added |
| | `watch_removed` | | Watch removed |
| | `watch_started` | | Watch started |
| | `directory_processing_started` | path | Directory scan started |
| | `directory_processing_completed` | path | Directory scan complete |
| **Queue** | | | |
| | `queue_item_added` | | Item added to queue |
| | `queue_item_updated` | | Item status changed |
| | `queue_item_processing` | | Item processing started |
| | `queue_item_completed` | | Item processing complete |
| | `queue_item_failed` | | Item processing failed |
| | `queue_item_removed` | | Item removed from queue |
| | `queue_paused` | | Queue paused |
| | `queue_resumed` | | Queue resumed |
| **Scheduler** | | | |
| | `scheduler_paused` | | Scheduler paused queue |
| | `scheduler_resumed` | | Scheduler resumed queue |
| **General** | | | |
| | `status_update` | | General status update |
| | `error` | message | Error occurred |
| | `info` | message | Info message |
| | `shutting_down` | | Server shutting down |

### Keepalive

The SSE endpoint sends a comment (`: keepalive`) every 15 seconds when no updates are available. This prevents proxy/browser timeouts.

---

## Error Responses

All endpoints may return errors in the format:

```json
{
  "error": "Description of the error"
}
```

Common HTTP status codes:
- `400` - Bad request (invalid input)
- `404` - Resource not found
- `500` - Internal server error

---

## File Processing Pipeline

Files go through the following stages:

1. **DISCOVERED** - File detected in watched directory
2. **PARSED** - Content extracted (text, metadata)
3. **SUMMARIZED** - AI summary and keywords generated
4. **COMPLETE** - Embeddings stored, fully indexed
5. **FAILED** - Processing error (check `processing_error` field)

---

## Configuration Files

| File | Location | Description |
|------|----------|-------------|
| Settings | `~/Library/Application Support/cosma/settings.toml` | Main configuration |
| Filters | `~/Library/Application Support/cosma/filter.json` | Include/exclude patterns |
| Database | `~/Library/Application Support/cosma/cosma.db` | SQLite database |
